# 画像処理ツール GUI化計画書

## 1. 目的

既存のコマンドライン画像処理ツール (`resize_images.py`) の機能をGUIで利用できるようにする。
ユーザーがより直感的に操作できるようにし、ツールの利便性を向上させる。
既存の `resize_images_gui.py` は無視し、ゼロベースで開発する。

## 2. GUIライブラリ選定

以下のライブラリを検討し、**CustomTkinter** を採用する。

*   **Tkinter**: Python標準。シンプルだが見た目が古い。
*   **PyQt / PySide**: 高機能で美しいが、やや複雑。
*   **Kivy**: モダン、マルチタッチ対応。
*   **CustomTkinter**: Tkinterベースでモダンな外観。導入のしやすさと見た目のバランスが良い。

**採用理由**: CustomTkinterは、Tkinterの学習コストの低さを引き継ぎつつ、現代的なUIコンポーネントを提供するため。

## 3. 基本レイアウトと機能 (改訂)

### 3.1. 入力要素 (必須)

*   **ソースディレクトリ選択**:
    *   ボタン: クリックでフォルダ選択ダイアログ表示。
    *   表示ラベル: 選択されたパスを表示。
*   **出力先ディレクトリ選択**:
    *   ボタン: クリックでフォルダ選択ダイアログ表示。
    *   表示ラベル: 選択されたパスを表示。
*   **リサイズ幅**:
    *   入力フィールド (数値): デフォルト値 1280。
*   **JPEG品質**:
    *   入力フィールド (数値, 1-100): デフォルト値 85。

### 3.2. 基本オプション要素 (必須)

*   **ドライラン実行**: チェックボックス (デフォルト: OFF)。
*   **処理再開 (既存ファイルスキップ)**: チェックボックス (デフォルト: OFF)。
*   **ログレベル**: ドロップダウンリスト (DEBUG, INFO, WARNING, ERROR、デフォルト: INFO)。

### 3.3. 実行要素 (必須)

*   **処理開始ボタン**: クリックで画像処理を開始。

### 3.4. 表示要素 (必須)

*   **ログ表示エリア**:
    *   スクロール可能なテキストエリア。
    *   処理中のログメッセージやエラーメッセージをリアルタイム表示。
*   **プログレスバー**:
    *   処理全体の進捗を表示。
*   **処理結果サマリー**:
    *   処理したファイル数、成功数、エラー数、スキップ数。
    *   処理前後の合計ファイルサイズ、削減率。
    *   エラーが発生したファイルの情報。

### 3.5. 推奨機能 (ユーザビリティ向上)

*   **処理中の中断/キャンセルボタン**: GUIから処理を安全に停止。
*   **出力先フォルダの自動作成オプション**: 存在しない場合に自動作成。
*   **ドラッグ＆ドロップによるフォルダ指定**: ソース/出力ディレクトリのパス表示ラベルに、フォルダをドラッグ＆ドロップするとパスが設定される機能を実装する。
*   **処理完了通知**: OSの通知機能で完了を知らせる。
*   **入力値のリアルタイム検証とフィードバック**: 不正入力時に即座にエラー表示。

### 3.6. 高度なオプション機能

*   **ファイル名変更ルールの設定**:
    *   プレフィックス、サフィックスの指定。
    *   連番付与 (開始番号、桁数)。
*   **上書き処理の詳細設定**:
    *   「常に上書き」「上書き前に確認」「スキップ」「連番を付けて別名保存」から選択。
*   **ディスク空き容量チェック**: チェックボックス (デフォルト: OFF)。

### 3.7. その他機能 (検討)

*   設定の保存・読み込み機能 (例: `gui_config.json`)。
*   テーマ切り替え (ライトモード/ダークモード)。

## 4. 画面構成案 (CustomTkinter)

*   **メインウィンドウ**
    *   **左ペイン (設定エリア)**
        *   「入力設定」フレーム (ソース/出力ディレクトリ)
        *   「リサイズ設定」フレーム (幅/品質)
        *   「オプション」フレーム (基本オプション、推奨オプション、高度なオプションを配置)
        *   処理開始ボタン、中断ボタン
    *   **右ペイン (情報エリア)**
        *   タブ形式:
            *   「ログ出力」タブ (テキストエリア)
            *   「処理結果」タブ (サマリー表示)
    *   **下部 (ステータスバー)**
        *   プログレスバー
        *   現在の状態を示すメッセージラベル

## 5. 処理の流れ

1.  ユーザーがGUI上で各種設定を入力・選択。
2.  「処理開始」ボタンをクリック。
3.  入力値のバリデーションチェック。
4.  画像処理のコアロジック (`resize_core.py` の関数群) を別スレッドで実行。
    *   GUIのフリーズを防ぐため、`threading` モジュールを使用。
    *   処理スレッドからGUIスレッドへは `queue` モジュールを使って進捗やログ情報を安全に渡す。
5.  ログ表示エリアに進捗やメッセージをリアルタイムで更新。
6.  プログレスバーを更新。
7.  処理完了後、結果サマリーを表示。
8.  中断ボタンが押された場合、ワーカースレッドに通知し、安全に処理を停止する。

## 6. ファイル構成

*   `resize_images_gui.py`: GUIのメインスクリプト。
*   `resize_core.py`: 既存の画像処理コアモジュール (変更なしで再利用、または必要に応じてGUI向けに調整)。
*   (オプション) `gui_config.json`: GUI設定保存用ファイル。

## 7. 開発ステップ (詳細版・改訂)

### フェーズ 1: 基本UIの構築とコア入力

1.  **メインウィンドウと基本レイアウト作成:**
    *   [ ] CustomTkinterでメインウィンドウを作成する。
    *   [ ] 左ペイン（設定エリア）、右ペイン（情報エリア）、下部（ステータスバー）の基本骨格を配置する。
2.  **入力設定エリア (左ペイン上部):**
    *   [ ] 「入力設定」フレームを作成する。
    *   [ ] ソースディレクトリ選択ボタン (`CTkButton`) と選択パス表示ラベル (`CTkLabel`) を配置する。
    *   [ ] 出力先ディレクトリ選択ボタン (`CTkButton`) と選択パス表示ラベル (`CTkLabel`) を配置する。
    *   [ ] ボタンクリックでフォルダ選択ダイアログ (`filedialog.askdirectory`) が開くようにする。
3.  **リサイズ設定エリア (左ペイン中部):**
    *   [ ] 「リサイズ設定」フレームを作成する。
    *   [ ] リサイズ幅入力フィールド (`CTkEntry`、数値のみ許可) とラベルを配置する (デフォルト値設定)。
    *   [ ] JPEG品質入力フィールド (`CTkEntry`、数値1-100のみ許可) とラベルを配置する (デフォルト値設定)。
4.  **情報表示エリア (右ペイン):**
    *   [ ] タブウィジェット (`CTkTabview`) を配置する。
    *   [ ] 「ログ出力」タブを追加し、スクロール可能なテキストエリア (`CTkTextbox`) を配置する。
    *   [ ] 「処理結果」タブを追加し、結果表示用のラベルまたはテキストボックスを配置する (初期は空)。
5.  **ステータスバー (下部):**
    *   [ ] プログレスバー (`CTkProgressBar`) を配置する (初期は非表示または0%)。
    *   [ ] 状態メッセージ表示ラベル (`CTkLabel`) を配置する。
6.  **実行コントロール (左ペイン下部):**
    *   [ ] 「オプション」フレームの場所を確保しておく。
    *   [ ] 処理開始ボタン (`CTkButton`) を配置する (この時点ではダミーアクション)。

### フェーズ 2: 基本的な画像処理の実行と連携

7.  **入力値の取得とバリデーション (基本):**
    *   [ ] 処理開始ボタンクリック時に、各入力フィールドから値を取得する。
    *   [ ] 簡単なバリデーション（空でないか、数値範囲など）を実装する。
8.  **画像処理ワーカースレッドの準備:**
    *   [ ] `threading.Thread` を使用して、画像処理をバックグラウンドで実行するクラスまたは関数を定義する。
    *   [ ] 処理に必要なパラメータをスレッドに渡せるようにする。
9.  **`resize_core.py` との連携 (最小限):**
    *   [ ] ワーカースレッド内で `resize_core.py` の `find_image_files` と `resize_and_compress_image` (またはそれに類するコア関数) を呼び出すロジックを実装する (CLI版 `main` 関数を参考に)。
    *   注意: この段階では、エラー処理や詳細なオプションは後回しにし、まず画像が処理されることを目指す。
10. **進捗とログのGUIへの通知 (キュー、基本):**
    *   [ ] `queue.Queue` を作成し、ワーカースレッドとGUIスレッド間の通信に使用する。
    *   [ ] ワーカースレッドから処理中のファイル名や簡単な進捗をキューに入れる。
    *   [ ] GUIスレッドで定期的にキューをチェックし、ログエリアとプログレスバーを更新する (`after` メソッド使用)。
11. **処理開始ボタンのロジック (基本実行):**
    *   [ ] バリデーション成功後、ワーカースレッドを作成して開始する。
    *   [ ] 処理中はボタンを無効化する。

### フェーズ 3: ロギング、エラーハンドリング、結果表示の強化

12. **ロギング設定の本格統合:**
    *   [ ] `resize_images.py` の `setup_logger` を参考に、GUI用のロガー設定関数を作成・統合する。
    *   [ ] ログレベルの概念を導入し、詳細なログメッセージをログエリアに出力する。
    *   [ ] ログをファイルにも保存する機能を追加する (ログレベル選択UIは後述)。
13. **エラーハンドリング強化:**
    *   [ ] ワーカースレッド内での詳細な例外 (ファイルアクセスエラー、画像処理エラーなど) をキャッチする。
    *   [ ] エラー情報をキュー経由でGUIに通知し、ログエリアや専用のメッセージボックスでユーザーに分かりやすく表示する。
14. **処理結果サマリー表示:**
    *   [ ] ワーカースレッド完了後、処理結果（成功/エラー/スキップ数、サイズ削減情報など）を計算し、「処理結果」タブに表示する。
    *   [ ] プログレスバーを100%にし、ステータスラベルを「完了」にする。
    *   [ ] 処理開始ボタンを再度有効化する。

### フェーズ 4: 推奨機能の実装 (ユーザビリティ向上)

15. **オプションUI要素の配置 (準備):**
    *   [ ] 左ペインの「オプション」フレーム内に、チェックボックスやドロップダウンを配置する。
16. **ドライラン実行オプション:**
    *   [ ] ドライラン用チェックボックス (`CTkCheckBox`) を配置。
    *   [ ] ワーカースレッドにドライランモードを伝え、実際のファイル書き込みをスキップするように `resize_core.py` 側の処理 (または呼び出し方) を調整。
17. **処理再開 (既存ファイルスキップ) オプション:**
    *   [ ] 処理再開用チェックボックス (`CTkCheckBox`) を配置。
    *   [ ] ワーカースレッドで出力先に同名ファイルが存在する場合にスキップするロジックを追加。
18. **ログレベル選択オプション:**
    *   [ ] ログレベル選択ドロップダウン (`CTkComboBox` DEBUG, INFO, WARNING, ERROR) を配置。
    *   [ ] 選択されたログレベルをロガー設定に反映させる。
19. **処理中の中断/キャンセルボタン:**
    *   [ ] 「中断」ボタン (`CTkButton`) を処理開始ボタンの隣などに配置 (処理中のみ有効化)。
    *   [ ] クリックでワーカースレッドに中断要求を通知し、安全にループを抜けて処理を停止できるようにする (CLI版の `interrupt_requested` のような仕組み)。
20. **出力先フォルダの自動作成オプション:**
    *   [ ] 「出力先フォルダが存在しない場合に作成する」チェックボックス (`CTkCheckBox`) を配置。
    *   [ ] 処理開始前に、このオプションが有効なら出力先ディレクトリを作成するロジックを追加 (`os.makedirs(exist_ok=True)` など)。
21. **ドラッグ＆ドロップによるフォルダ指定:**
    *   [ ] (ライブラリ調査・実装) ソース/出力ディレクトリのパス表示ラベルに、フォルダをドラッグ＆ドロップするとパスが設定される機能を実装する。
22. **処理完了通知:**
    *   [ ] (ライブラリ調査・実装) 処理完了時に、OSの標準的な通知機能を使ってシンプルなメッセージを表示する (例: `plyer` ライブラリなど)。
23. **入力値のリアルタイム検証とフィードバック:**
    *   [ ] リサイズ幅や品質の入力フィールドで、入力が変更されるたびにバリデーションを行い、不正な場合は即座にフィールドの近くやステータスバーにエラーメッセージを表示する。

### フェーズ 5: 指定オプション機能の実装 (高度な設定)

24. **ファイル名変更ルールの設定UIとロジック:**
    *   [ ] 「ファイル名設定」などのセクションをオプションフレーム内に追加。
    *   [ ] プレフィックス入力フィールド (`CTkEntry`)。
    *   [ ] サフィックス入力フィールド (`CTkEntry`)。
    *   [ ] 連番付与オプション (チェックボックス、開始番号、桁数など)。
    *   [ ] ワーカースレッド内で、これらのルールに基づいて出力ファイル名を生成するロジックを `get_destination_path` 関数 (またはそれに類する関数) に組み込む。
25. **上書き処理の詳細設定UIとロジック:**
    *   [ ] 「上書き設定」などのセクションをオプションフレーム内に追加。
    *   [ ] ドロップダウン (`CTkComboBox`) またはラジオボタンで選択:
        *   「常に上書きする」
        *   「上書き前に確認する」(確認ダイアログ表示、実装が複雑な場合は初期は見送りも検討)
        *   「スキップする」(処理再開オプションと統合または別途実装)
        *   「連番を付けて別名で保存する」
    *   [ ] ワーカースレッド内で、選択された設定に基づいてファイル保存時の動作を分岐させる。

### フェーズ 6: 仕上げとテスト

26. **ディスク空き容量チェックオプション:**
    *   [ ] 「ディスク空き容量チェック」チェックボックス (`CTkCheckBox`) を配置。
    *   [ ] 処理開始前に、推定出力サイズとディスク空き容量を比較し、不足する場合は警告を出す。
27. **設定の保存・読み込み機能 (検討):**
    *   [ ] (オプション) 現在のGUI設定（ディレクトリパス、数値入力、オプション状態）をJSONファイルなどに保存/読み込みする機能を実装する。
28. **テーマ切り替え機能 (検討):**
    *   [ ] (オプション) CustomTkinterのテーマ変更機能を利用して、ライト/ダークモード切り替えオプションを実装する。
29. **総合テストとデバッグ:**
    *   [ ] 様々な画像、ファイル数、設定の組み合わせでテストを行う。
    *   [ ] エラーケース、境界値テストを入念に行う。
    *   [ ] 大量の画像ファイルでの処理テスト。
    *   [ ] 特殊なファイル名やパスでのテスト。
30. **コードのリファクタリングと整理:**
    *   [ ] GUIロジックを適切なクラスやメソッドに分割する。
    *   [ ] コメントを追加し、可読性を向上させる。
    *   [ ] 不要なコードを削除し、全体をクリーンにする。
